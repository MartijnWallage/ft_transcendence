

{% extends 'main/base.html' %}
{% load static %}

{% block title %}Pong Game{% endblock %}

{% block content %}
<style>
    canvas {
        display: block;
        margin: auto;
        background: #000;
    }

    body {
        background: url("{% static 'images/pong.png' %}") no-repeat center center fixed;
        background-size: cover;
    }
    .content {
        background-color: rgba(255, 255, 255, 0.8);
        padding: 20px;
        border-radius: 10px;
        margin-top: 50px;
    }
    .chat-container {
        position: absolute;
        right: 20px;
        top: 60px;
        width: 300px;
        max-height: 400px;
        overflow-y: auto;
        background-color: white;
        border: 1px solid #ccc;
        padding: 10px;
        display: none;
    }
    .chat-message {
        margin-bottom: 10px;
    }
    .chat-input {
        display: flex;
    }
    .chat-input input {
        flex: 1;
        padding: 5px;
    }
    .chat-input button {
        padding: 5px;
    }
</style>

<div id="gameModeSelection" style="text-align:center; margin-bottom:20px;">
    {% if is_logged_in %}
        <button type="button" class="btn btn-success" onclick="selectGameMode('remote')">Remote Play</button>
    {% else %}
        <button type="button" class="btn btn-success" onclick="selectGameMode('remote')">Remote Play</button>
    {% endif %}
</div>

<!-- <div id="nameInputs" style="display:none;">
    {% if is_logged_in %}
        <p>Player 1: {{ user.username }}</p>
    {% else %}
        <p>Player 1: Guest</p>
    {% endif %}
    <input type="text" id="player2Name" class="name-input" placeholder="Player 2 Name">
    <button type="button" class="btn btn-primary" onclick="startGameWithPlayer2()">Start Game</button>
</div> -->

<div id="remotePlay" style="display:none;">
    <p>Waiting for another player to join...</p>
    <button type="button" class="btn btn-danger" onclick="cancelRemotePlay()">Cancel</button>
    <button type="button" class="btn btn-primary" onclick="initiateRemotePlay()" id="startGameButton">Start Game</button>
</div>

<div id="gameButtons" style="display:none;">
    <button type="button" class="btn btn-danger" onclick="endGame()">End Game</button>
</div>

<canvas id="pongCanvas" width="600" height="400" style="display:none;"></canvas>

<!-- Chat Room -->
<!-- main container for the entire chat room -->
<div id="chatContainer" class="chat-container">
    <!-- Inside chatContainer, there is another div with ID chatMessages and class chat-messages. 
        This div will hold all the chat messages exchanged between users. -->
    <div id="chatMessages" class="chat-messages"></div>
    <!-- This div with class chat-input contains the input field and the send button for users to send messages. -->
    <div class="chat-input">
        <input type="text" id="chatMessageInput" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>


    let pingpongsocket = null; // Define pingpongsocket globally
    let is_first_player = false;
    let is_player_ready = false;
    let is_opponent_ready = false;

    function initializepingpongWebSocket() {
        
        pingpongsocket = new WebSocket('wss://10.15.109.3:8443/ws/pingpongsocket/');
        
        pingpongsocket.onopen = function(event) {
            console.log('WebSocket connection opened');
            // Assuming you need to send an 'initiate_remote_play' message to start
            initiateRemotePlay();
        };

        pingpongsocket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log('Message from server:', data);

            if (data.type === 'players_ready') {
                is_opponent_ready = true;
                console.log('Both players are ready to start the game.');
                if (is_player_ready && is_opponent_ready) {
                    startRemoteGame('Player 1', 'Player 2', 'remote', is_first_player);
                }
            } else if (data.type === 'game_state') {
                updateGameState(data.state);
            }

            // if (data.role === 'first') {
            //     startRemoteGame(player1Name, player2Name, mode, true); // This player is the 1st player
            // } else if (data.role === 'second') {
            //     startRemoteGame(player1Name, player2Name, mode, false); // This player is the 2nd player
            // } else {
            //     console.error('Unknown player role received.');
            // }
            

        

            // if (data.type === 'status' && data.message === 'Remote play initiated!') {
            //     isHost = true; // Assume the initiator is the host
            // }

            // if (data.type === 'game_state') {
            //     updateGameState(data.data);
            // }

            // if (data.type === 'player_connected' && !isHost) {
            //     document.getElementById('remotePlay').innerHTML = `
            //         <p>Another player has joined!</p>
            //         <button type="button" class="btn btn-primary" onclick="startRemoteGame()">Start Remote Game</button>
            //     `;
            // }

            // if (data.type === 'player_disconnected' && !isHost) {
            //     alert('The other player has disconnected.');
            //     // Handle disconnection logic, e.g., show a message or return to game mode selection
            // }



            // if (data.type === 'start_game') {
            //     // Start the game when the 'start_game' message is received
            //     const player1Name = '{{ user.username|default:"Guest" }}'; // Replace with actual player 1 name
            //     const player2Name = 'Player 2'; // Replace with actual player 2 name
            //     const mode = 'remote'; // Set the game mode
            //     startGame(player1Name, player2Name, mode);
            // }

            // Handle other message types as needed
        };

        pingpongsocket.onclose = function(event) {
            console.log('WebSocket connection closed');
            // handleWebSocketClose();
            // Set a timeout to attempt reconnecting after 15 seconds
            // setReconnectTimeout();
        };
    }

    function selectGameMode(mode) {
        if (mode === 'remote') {
            document.getElementById('gameModeSelection').style.display = 'none';
            document.getElementById('remotePlay').style.display = 'block';
            document.getElementById('chatContainer').style.display = 'block'; // Show chat room
            initializechatWebSocket();
            initializepingpongWebSocket();

            // Set is_first_player based on user's role
            is_first_player = true; // This player is the first player
            // document.getElementById('remotePlay').innerHTML = `
            //     <p>Waiting for another player to join...</p>
            //     <button type="button" class="btn btn-danger" onclick="cancelRemotePlay()">Cancel</button>
            //     <button type="button" class="btn btn-primary" onclick="initiateRemotePlay()" id="startGameButton">Start Game</button>
            // `;
        }
    }

    function cancelRemotePlay() {
        document.getElementById('remotePlay').style.display = 'none';
        document.getElementById('gameModeSelection').style.display = 'block';
        if (pingpongsocket) {
            pingpongsocket.close(); // Close the WebSocket connection when canceling remote play
        }  
    }

    function initiateRemotePlay() {
        const message = { type: 'initiate_remote_play', role: 'first' }; // Adjust 'role' as needed
        sendMessageToWebSocket(message);
    }

    // function sendGameState(gameState) {
    //     const message = { type: 'game_state_update', data: gameState };
    //     if (pingpongsocket.readyState === WebSocket.OPEN) {
    //         pingpongsocket.send(JSON.stringify(message));
    //     } else {
    //         console.error('WebSocket is not open to send messages.');
    //     }
    // }

    function actionData(data) {
        // data parameter contains the incoming message data
        if (data.type === 'game_state') {
            updateGameState(data.state); // Update game state based on received data
        } else {
            console.error('Unknown message type received:', data.type);
        }
    }

    // function sendMessageToWebSocket(message) {
    //     if (pingpongsocket && pingpongsocket.readyState === WebSocket.OPEN) {
    //         pingpongsocket.send(JSON.stringify(message));
    //         console.log('Message sent:', message);
    //     } else {
    //         console.error('WebSocket is not open to send messages. Retrying...');
    //         setTimeout(() => sendMessageToWebSocket(message), 1000); // Retry after 1 second
    //     }
    // }

    function sendMessageToWebSocket(message) {
        if (pingpongsocket && pingpongsocket.readyState === WebSocket.OPEN) {
            pingpongsocket.send(JSON.stringify(message));
            console.log('Message sent:', message);
        } else {
            console.error('WebSocket is not open to send messages. Retrying...');
            setTimeout(() => sendMessageToWebSocket(message), 1000); // Retry after 1 second
        }
    }


    function sendGameState() {
        const state = {
            player1: { x: player1.x, y: player1.y },
            player2: { x: player2.x, y: player2.y },
            ball: { x: ball.x, y: ball.y },
            player1Score: player1Score,
            player2Score: player2Score
        };
        const message = { type: 'game_state', state: state };
        sendMessageToWebSocket(message);
    }

    function sendPlayerAction(actionData) {
        const message = {
            type: 'player_action',
            data: actionData
        };
        if (pingpongsocket.readyState === WebSocket.OPEN) {
            pingpongsocket.send(JSON.stringify(message));
        } else {
            console.error('WebSocket is not open to send messages.');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const remotePlayButton = document.getElementById('remotePlay');
        if (remotePlayButton) {
            remotePlayButton.style.display = 'none'; // Ensure the remotePlay div is visible
        } else {
            console.error('Remote play button container not found in the DOM.');
        }
    });

    


    // function endGame() {
    //     var redirecturi = "/";
    //     window.location.href = redirecturi;
    // }

    

    // function handleWebSocketClose() {
    //     if (reconnectAttempts < 5) {
    //         reconnectAttempts++;
    //         console.log(`Reconnecting... (attempt ${reconnectAttempts})`);
    //         setTimeout(initializePingPongWebSocket, 1000 * reconnectAttempts); // Exponential backoff
    //     } else {
    //         console.error('Maximum reconnect attempts reached. Could not reconnect to WebSocket.');
    //     }
    // }

    function startRemoteGame(player1Name, player2Name, mode, isFirstPlayer) {
        console.log(`Starting remote game with ${player1Name} and ${player2Name} in ${mode} mode. First player: ${isFirstPlayer}`);
        isPlayerFirst = isFirstPlayer;
        // document.getElementById('gameButtons').style.display = 'block';
        // document.getElementById('pongCanvas').style.display = 'block';
        gameMode = mode;
        gameLoop(); // Assuming gameLoop is defined somewhere else
        
    }

    function players_ready() {
        const message = { type: 'player_ready', data: {} };
        sendMessageToWebSocket(message);
        is_player_ready = true;
    }

    // function startGame(player1Name, player2Name, mode, isFirstPlayer) {
    //     document.getElementById('gameButtons').style.display = 'block';
    //     document.getElementById('pongCanvas').style.display = 'block';
    //     initializeGame(player1Name, player2Name, mode, isFirstPlayer);
    // }




    // function startRemoteGame() {
    //     const message = { type: 'start_game', data: {} };
    //     if (pingpongsocket.readyState === WebSocket.OPEN) {
    //         pingpongsocket.send(JSON.stringify(message));
    //         console.log('Starting remote game...');
    //     } else {
    //         console.error('WebSocket is not open to send messages.');
    //     }
    // }

    // function setReconnectTimeout() {
    //     // Clear any existing timeout before setting a new one
    //     clearReconnectTimeout();
    //     reconnectTimeout = setTimeout(() => {
    //         console.log('Attempting to reconnect...');
    //         initializepingpongWebSocket(); // Attempt to reconnect
    //     }, 5000); // 5 seconds timeout
    // }

    // function waitForSecondPlayer() {
    //     setTimeout(() => {
    //         if (!isHost && pingpongsocket.readyState === WebSocket.OPEN) {
    //             pingpongsocket.close();
    //             console.log('No second player joined in time. Closing WebSocket.');
    //         }
    //     }, 10000); // 10 seconds wait time
    // }




    function initializechatWebSocket() {
        // WebSocket allows for efficient, bidirectional communication, 
        // making it suitable for applications like chat rooms, live updates, and multiplayer games

        let chatSocket = new WebSocket('wss://10.15.109.3:8443/ws/chatsocket/');

        // When a message is received from the chatSocket server
        // the onmessage event handler is triggered.
        // The event object e contains the message data.
        chatSocket.onmessage = function(e){
            // This data is parsed from JSON format 
            // into a JavaScript object and logged to the console(debug)
            let data = JSON.parse(e.data);
            console.log('Data:', data);
            
            // A container for chat messages
            let chatMessages = document.getElementById('chatMessages');
            // Create a new 'div' element
            let newMessage = document.createElement('div');
            // Assigned classname and textcontect
            newMessage.className = 'chat-message';
            newMessage.textContent = data.message;
            // Appends the new message div to the chatMessages container
            chatMessages.appendChild(newMessage);
            // Scroll to the bottom
            chatMessages.scrollTop = chatMessages.scrollHeight; 
        }

        window.sendMessage = function() {
            // Selects the DOM element where the user types their message.
            let messageInput = document.getElementById('chatMessageInput');
            // Gets the value (i.e., the message text) from the input field.
            let message = messageInput.value;
            // Sends the message to the WebSocket server, first converting it to a JSON string.
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            // Clears the input field after sending the message.
            messageInput.value = '';
        }
    }



</script>

<script src="{% static 'js/pong.js' %}"></script>




{% endblock %}



